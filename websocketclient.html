<!DOCTYPE html>
<html>
 
<head>
    <title>Visual tweet trends</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
</head>
 
<body>
    <section id="chart"></section>
    <section id="secondary_section"></section>
    <span id = "span">
        <div class = "images">
            <div><button id="start" type="button" class="start" onclick="getTweets()"></button></div>
            <div><button id="stop" type="button" class="stop"></button></div>
            <div><button id="back" type="button" class="back" onclick="goToRoot()"></button></div>
        </div>
    </span>
    <div>
      <input type="text" name="tag" id="tag" placeholder="HashTag...">
      <button onclick="addTag()">+</button>
      <button onclick="removeTag()">-</button>
    </div>
</body>
 
<script type="text/javascript">
    
    var map_color = {};

    var node_red = [];
   
    var level = 'root';
 
    var chart = '';

    var tag_input = 1;
 
    var diameter = 600;
 
    var svg = d3.select('#chart').append('svg')
                .attr('width', diameter)
                .attr('height', diameter);
 
    var bubble = d3.layout.pack()
                   .size([diameter,diameter])
                   .value(function(d) { return d.size; }) //i nuovi dati vengono caricati nel layout a bolla
                   .padding(3);                           //si tiene un piccolo padding intorno alle bolle
   
    var div = d3.select("section").append("div")   
                .attr("class", "tooltip")              
                .style("opacity", 0);

    function getSize(d) {
      var bbox = this.getBBox(),
      cbbox = this.parentNode.getBBox(),
      scale = cbbox.width/bbox.width;
      d.scale = scale;
    }

    function removeTag() {  	
    	if(tag_input > 1){	
    		d3.select('#T'+tag_input).remove();
    		tag_input = tag_input-1;
    	}
    }

    function addTag() {	
    	if(tag_input<5) {
    		tag_input = tag_input + 1;
    		d3.select("body").append('div').append("input").attr("placeholder","Hashtag...").attr("id",'T'+tag_input);
    	}
    }
 
    //funzione per rendere il dizionario del server nel formato richiesto da d3
    function processData(data,level) {
 
        data = JSON.parse(data)
 
        var newDataSet = [];
 
        if(level === 'root') {
            for(var mainhashtag in data) {
                var sum = 0;
                for(var hashtag in data[mainhashtag]) {
                    sum += data[mainhashtag][hashtag][0];
                }
                newDataSet.push({name: mainhashtag, className: mainhashtag, size: sum});
            }
        }
        else {
            for(var mainhashtag in data) {
                if(mainhashtag === level) {
                    for(var hashtag in data[mainhashtag]) {
                        newDataSet.push({name: hashtag, className: mainhashtag, size: data[mainhashtag][hashtag][0], cotag: data[mainhashtag][hashtag][1]})
                    }
                }
            }
        }
 
        return {children: newDataSet};
    }
 
    function goToRoot() {
        level = 'root';
        duration = 200;
        delay = 0;
        d3.select('#back')
          .transition()
          .duration(100)
          .style('opacity', 0);
        d3.selectAll('circle')
          .transition()
          .duration(duration + delay)
          .style('opacity', 0)
          .each('start', function() {
            id = d3.select(this).attr('id');
            d3.select(this).remove();
            d3.select('#T'+id).remove();
          });
        d3.selectAll('div.tooltip')
          .transition()
          .duration(0)
          .style('opacity', 0);
        d3.select('#level_name').remove()
        drawBubbles();
    }

    function dynamicColor(bubble) {
        size = bubble.size;
        col = map_color[bubble.className];
        color = col.split(',');
        if (parseInt(color[2].substring(0, color[2].indexOf('%')))-size <= 50) {
            color[2] = 50;
            color = color.toString();
        }
        else {
            color[2] = parseInt(color[2].substring(0, color[2].indexOf('%'))) - size;
            color = color.toString();
        }
        return 'hsl('+color+'%)';
    }
 
    function drawBubbles() {
 
        var nodes = bubble.nodes(processData(chart,level))
                          .filter(function(d) { return !d.children; });

        var text = svg.selectAll('text')
                      .data(nodes, function(d) { return d.name; });

        var vis = svg.selectAll('circle')
                     .data(nodes, function(d) { return d.name; });
 
        var duration = 200;
        var delay = 0;
           
        // update - questo si applica in fase di aggiornamento di nodi giÃ  esistenti
        vis.transition()
           .duration(duration)
           .delay(function(d, i) { delay = i * 7; return delay; })
           .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
           .attr('r', function(d) { return d.r; })
           .style('opacity', 1)
           .style('fill', function(d) {
              if(node_red.indexOf(d.name)!=-1) {
                return 'red'
              }
              else {
                return dynamicColor(d);
              }
           });
       
        text.transition()
            .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
            .attr('text-anchor', 'middle')
            .style("font-size", function(d) {
                console.log(d.r)
                var len = d.name.substring(0, d.r / 3.5).length;
                console.log(len)
                var size = d.r/3.55;
                if (size>75) size = 75;
                return Math.round(size)+'px';
            })
            .text(function(d) {
              if (d.r<22){
              var text = '';
            }else{
              var text = d.name.substring(0, d.r / 3.5) + ' ' + d.size;
            }
            return text;
          });

        // enter - questo si applica ai nuovi nodi in entrata
        vis.enter().append('circle')
           .attr('id', function(d) { return d.name; })
           .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
           .attr('r', function(d) { return d.r; })
           .attr('class', function(d) { return d.className; })
           .style('opacity', 0)
           .on('mouseover', function(d) {
                div.transition()       
                   .duration(0)    
                   .style("opacity", .9);      
                div.html("#"+d.name + "<br/>"  + d.size)   
                   .style("left", (d3.event.pageX) + "px")     
                   .style("top", (d3.event.pageY - 28) + "px");
                if(level != 'root') {
                  cotaglist = d.cotag;
                  d3.select(this).style('fill','red');
                  d3.select('#secondary_section').append('div').attr('class','secondary_section').append('text').text(d.name);
                  node_red.push(d.name);
                  d3.selectAll('circle').each(function(d) {
                    if(cotaglist.indexOf(d.name)!=-1) {
                      d3.select(this).style('fill','red');
                      d3.select('#secondary_section').append('div').attr('class','secondary_section').append('text').text(d.name);
                      node_red.push(d.name);
                    }
                  });
                }
            })
           .on('mouseout', function(d) {       
                div.transition()       
                    .duration(500)     
                    .style("opacity", 0);
                d3.selectAll('div.secondary_section').remove();
                node_red = [];
                d3.selectAll('circle').transition().duration(100).style('fill', function(d) {
                    return dynamicColor(d);
                })
            })
           .on('click', function(d) {
                if(level === 'root'){
                    level = d.name;
                    d3.selectAll('circle')
                      .transition()
                      .duration(duration + delay)
                      .style('opacity', 0)
                      .each('start', function() {
                        id = d3.select(this).attr('id');
                        d3.select(this).remove();
                        d3.select('#T'+id).remove();
                      });
                    d3.selectAll('div.tooltip')
                      .transition()
                      .duration(0)
                      .style('opacity', 0);
                    d3.select('#secondary_section')
                      .append('text')
                      .attr('id','level_name')
                      .style('color', function() {
                        color = map_color[d.className];
                        color = color.split(',');
                        color[2] = '50%';
                        return 'hsl('+color.toString()+')';
                      })
                      .text('#'+d.name);
                    d3.select('#back')
                      .transition()
                      .duration(100)
                      .style('opacity', 1);       
                    drawBubbles();       
                 }
            })
           .transition()
           .duration(duration * 1.2)
           .style('fill', function(d){
              if(node_red.indexOf(d.name)!=-1) {
                return 'red';
              }
              else {
                return dynamicColor(d);
              }
           })
           .style('opacity', 1);

        text.enter()
            .append('text')
            .attr('id', function(d) { return 'T'+d.name; })
            .text(function(d){ return d.name })
            .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; })
            .attr('text-anchor', 'middle')
            .style("font-size", function(d) {
                console.log(d.r)
                var len = d.name.substring(0, d.r / 3.5).length;
                var size = d.r/3.55;
                size *= 10 / len;
                if (size>75) size = 75;
                return Math.round(size)+'px';
      })
      .text(function(d) {
          if (d.r<22){
            var text = '';
          }else{
            var text = d.name.substring(0, d.r / 3.5) + ' ' + d.size;
          }
          return text;
        });

        // exit - questo si applica ai nodi che dovranno scomparire
        vis.exit()
           .transition()
           .duration(duration + delay)
           .style('opacity', 0)
           .remove();
    }
 
    //funzione principale
    function getTweets() {

      if(document.getElementById('tag').value=='') {
        window.alert('Devi inserire almeno un Hashtag');
      }
      else {
        
        document.getElementById("start").disabled = true;
        
        tag1 = document.getElementById("tag").value;

  	    colors = ['130,100%,85%','15,100%,85%','320,100%,85%','60,100%,85%'];

        map_color[tag1] = '190,100%,85%';

      	for (i=2;i<=tag_input;i++) {
      		map_color[document.getElementById("T"+i).value] = colors[i-2];
      	}

        //connessione al websocket server
        var connection = new WebSocket('ws://127.0.0.1:9000/ws');
        var buttonStop = document.getElementById("stop");
   
        //chiudi la connessione con il server quando si clicca su stop
        buttonStop.onclick = function() {
        	document.getElementById("start").disabled = false;
          if (connection.readyState === WebSocket.OPEN) {
              connection.close();
          }
        }
   
        //appena si apre la connessione con il server, il client invia il messaggio Start
        connection.onopen = function() {
        	message = document.getElementById("tag").value+' ';
          for (i=2;i<=tag_input;i++){
            message += document.getElementById("T"+i).value+' ';
          }
          message = message.slice(0,-1);
          connection.send(message);
        }
   
        //visualizzazione su console di eventuali errori
        connection.onerror = function(error) {
            console.log('Error: ' + error);
        }
   
        //funzione che reagisce ai messaggi che il server invia al client
        connection.onmessage = function(e) {
            console.log(e.data)
            chart = e.data;
            drawBubbles();
        }
   
        //funzione che reagisce alla chiusura della connessione con il server
        connection.onclose = function() {
            console.log('connessione chiusa');
        }
      }
    }
 
</script>
 
<style type="text/css">
    
    div.tooltip {  
        position: absolute;        
        text-align: center;        
        width: auto;                   
        height: 28px;                  
        padding: 2px;              
        font: 12px sans-serif;     
        background: lightsteelblue;
        border: 0px;       
        border-radius: 8px;        
        pointer-events: none;          
    }
 
    #chart{
        float: left;
    }
 
    #secondary_section{
        float: right;
    }
 
    #level_name{
        font-size: 60px;
        vertical-align: top;
        text-align: right;
        font-family: fantasy;
    }
 
    .start {
        background: url('icons/start.png');
        background-repeat: no-repeat;
        border: 0;
        width: 64px;
        height: 64px;
    }
 
    .stop {
        background: url('icons/stop.png');
        background-repeat: no-repeat;
        border: 0;
        width: 64px;
        height: 64px;
    }
 
    .back {
        background: url('icons/up-arrow.png');
        background-repeat: no-repeat;
        border: 0;
        width: 64px;
        height: 64px;
        opacity:0;
 
    }

  	button:disabled,
  	button[disabled]{
  	  border: 1px solid #999999;
  	  background-color: #cccccc;
  	  color: #666666;
  	}
 
    .images {
        white-space: nowrap;
    }
 
</style>
 
</html>